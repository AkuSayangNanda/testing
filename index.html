<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Our Little Story</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Playfair+Display:ital,wght@0,400;0,700&family=Dancing+Script:wght@500&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f6f0e7; --paper:#fff8f2; --accent:#b98a5a; --muted:#887766; --text:#2b2b2b;
      --soft: rgba(43,43,43,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Poppins,system-ui,Arial;background:linear-gradient(180deg,#f6f0e7,#ede5d7);color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    header{display:flex;gap:14px;align-items:center;margin:20px 0}
    .logo{font-size:44px}
    h1{margin:0;font-size:22px;color:var(--accent);font-family:'Dancing Script',cursive}
    p.sub{margin:4px 0 0;color:var(--muted)}
    /* small bgm toggle */
    .controls {margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn-icon{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:8px;border-radius:10px;cursor:pointer;font-weight:600;color:var(--muted)}
    .btn-icon.active{background:linear-gradient(90deg,var(--accent),#d9b18a);color:#fff;border:0}

    /* Intro overlay */
    .introOverlay{position:fixed;inset:0;background:linear-gradient(180deg,rgba(255,250,245,0.9),rgba(255,250,245,0.95));display:flex;align-items:center;justify-content:center;z-index:400}
    .introCard{background:var(--paper);padding:28px;border-radius:14px;max-width:620px;text-align:center;box-shadow:0 20px 60px rgba(11,8,6,0.12)}
    .introCard h2{margin:0;font-family:'Dancing Script',cursive;font-size:34px;color:var(--accent)}
    .introCard p{color:var(--muted);margin-top:12px}
    .introCard button{margin-top:18px;padding:10px 16px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--accent),#d9b18a);color:#fff;font-weight:700;cursor:pointer}

    /* dust particles */
    .dust{position:fixed;inset:0;pointer-events:none;z-index:60;opacity:0.12}
    .dust span{position:absolute;background:rgba(0,0,0,0.04);border-radius:50%;filter:blur(0.2px)}

    /* main container */
    main.container{max-width:920px;margin:0 auto;padding-bottom:120px}

    /* block layout */
    .block{display:grid;grid-template-columns:1fr 1fr;gap:22px;align-items:center;margin:36px 0;padding:22px;border-radius:16px;background:var(--paper);border:1px solid rgba(0,0,0,0.04);box-shadow:0 10px 40px rgba(0,0,0,0.06);position:relative;overflow:visible;transition:transform .6s cubic-bezier(.2,.9,.2,1),opacity .6s}
    .block.hidden{opacity:0;transform:translateY(22px)}
    .block.visible{opacity:1;transform:translateY(0)}
    .block.reverse{direction:rtl}
    .photo{position:relative;border-radius:14px}

    /* polaroid frame + spotlight */
    .frame{background:#fff;padding:14px;border-radius:12px;display:inline-block;box-shadow:0 14px 40px rgba(2,6,23,0.06);transform:rotate(var(--r,0deg));transition:filter .4s, transform .4s}
    .frame img{display:block;width:360px;height:360px;object-fit:cover;border-radius:6px;filter:contrast(0.98) saturate(0.9) sepia(0.06)}
    .frame:hover{transform:scale(1.02) rotate(calc(var(--r,0deg) * 0.6));filter:brightness(1.03) saturate(1.05)}
    .spotlight{position:absolute;left:0;top:0;right:0;bottom:0;border-radius:12px;pointer-events:none;background:radial-gradient(400px 200px at 30% 30%, rgba(255,248,240,0.35), transparent 30%)}
    .film{position:absolute;inset:12px;border-radius:8px;pointer-events:none;background-image:linear-gradient(transparent, rgba(0,0,0,0.02));mix-blend-mode:overlay}
    .captionStrip{margin-top:10px;text-align:center;color:var(--text);font-weight:600;font-size:13px}

    /* handwritten mini quote */
    .miniQuote{position:absolute;font-family:'Dancing Script',cursive;font-size:15px;color:rgba(80,60,40,0.95);transform:rotate(-6deg);right:12px;top:8px}
    .block.reverse .miniQuote{left:12px;right:auto;transform:rotate(6deg)}

    .textBlock h3{margin:0;color:var(--text);font-size:18px;display:flex;align-items:center;gap:8px}
    .heartText{margin-top:14px;color:#342f2a;line-height:1.85;font-size:18px;font-family:'Playfair Display',serif;min-height:84px}
    .smallNote{margin-top:12px;color:var(--muted);font-size:13px}

    /* cat sticker */
    .catSticker{position:absolute;right:12px;bottom:12px;font-size:22px;opacity:0.95}
    .block.reverse .catSticker{left:12px;right:auto}

    /* monologue */
    .mono{padding:34px;border-radius:14px;background:linear-gradient(180deg,#fff9f4,#fff6ee);text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.04);margin:36px 0}
    .mono h2{font-family:'Dancing Script',cursive;font-size:28px;margin:0;color:var(--accent)}
    .mono p{margin-top:16px;color:#4b4037;font-size:17px;line-height:1.8}

    /* video block */
    .videoWrap{display:flex;flex-direction:column;gap:12px;align-items:center;margin:28px 0}
    .videoWrap video{
  width: 100%;
  max-width: 860px;
  height: auto;
  object-fit: contain;
  background: #000;
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,0.04);
  box-shadow: 0 10px 40px rgba(0,0,0,0.06);
  display: block;
}
    .videoCaption{color:var(--muted);font-size:14px;text-align:center}
    .playVideoBtn{margin-top:8px;padding:8px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--accent),#d9b18a);color:#fff;cursor:pointer;font-weight:700}

    /* typing caret */
    .caret{display:inline-block;width:6px;height:20px;background:var(--accent);margin-left:6px;vertical-align:middle;animation:blink 1s steps(2,end) infinite}
    @keyframes blink{50%{opacity:0}}

    /* final overlay */
    .finalOverlay{position:fixed;inset:0;background:#0b0a08;display:flex;align-items:center;justify-content:center;color:#f6efe6;z-index:300;opacity:0;pointer-events:none;transition:opacity .9s}
    .finalOverlay.show{opacity:1;pointer-events:auto}

    /* surprise toast & emphasis */
    .surprise{position:fixed;left:50%;transform:translateX(-50%);bottom:20px;background:linear-gradient(90deg,#fff7f0,#fff2ea);color:#4b4037;padding:12px 18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.12);z-index:1100;font-weight:600}
    .heartBadge{display:inline-block;margin-left:8px;font-size:20px;vertical-align:middle;transform-origin:center;animation:heartBeat 1.2s infinite}
    @keyframes heartBeat{0%{transform:scale(1)}25%{transform:scale(1.18)}45%{transform:scale(0.95)}100%{transform:scale(1)}}
    .block.emph{box-shadow:0 20px 60px rgba(185,138,90,0.12);transform:translateY(-6px) scale(1.02);transition:transform .6s,box-shadow .6s}

    @media(max-width:980px){.frame img{width:100%;height:auto;max-height:420px}.block{grid-template-columns:1fr}.block.reverse{direction:ltr}.miniQuote{display:none}}
    @media(max-width:520px){.wrap{padding:12px}.frame img{height:220px}}
  </style>
</head>
<body>

  <!-- BGM element (replace bergema.mp3 if you have another file) -->
  <audio id="bgm" src="bergema.mp3" loop preload="auto"></audio>

  <!-- INTRO -->
  <div class="introOverlay" id="intro">
    <div class="introCard">
      <h2>This our little story</h2>
      <p>Haiii sayangku cintaku Sebelum kamu masuk‚Ä¶ aku cuma mau bilang Makasihhh yaaa sayangkuu. Karena kamu pernah hadir di hidup aku dengan cara yang nggak pernah aku minta, tapi selalu aku syukuri.</p>
      <button id="enterBtn">Open our story</button>
    </div>
  </div>

  <!-- dust -->
  <div class="dust" id="dust"></div>

  <div class="wrap">
    <header>
      <div class="logo">üê±</div>
      <div>
        <h1>Our Story <span id="hb" class="heartBadge">üíì</span></h1>
        <p class="sub">Salah Satu momen terbesar tahun ini. Geser perlahan.</p>
      </div>

      <div class="controls" aria-hidden="false">
        <button id="bgmToggle" class="btn-icon" title="Play / Pause background music">üîä BGM</button>
      </div>
    </header>

    <main class="container">
      <!-- Block 1 -->
      <section class="block hidden" data-index="1">
        <div class="photo">
          <div class="frame" style="--r:-4deg">
            <img src="1.jpg" alt="foto-1" data-caption="Hari itu hatiku tak pernah berhenti tersenyum sejak bertemu denganmu.">
            <div class="captionStrip">Our First meet</div>
            <div class="film"></div>
          </div>
          <div class="spotlight"></div>
          <div class="hearts"></div>
          <div class="miniQuote">"hadirnya kamu, Terbitnya sinar duniaku"</div>
        </div>
        <div class="textBlock">
          <h3>Untukmu</h3>
          <div class="heartText" data-raw="Ketika tahun hampir menutup usia, ketika duniaku masih saja sama seperti tahun sebelumnya, Beberapa momen datang tanpa permisi, Momen yang tak pernah kusangka-sangka datangnya. Ya.. kamulah momen itu sayang, Momen yang membuat aku selalu bersyukur setiap harinya sejak setelah bertemu kamu."></div>
          <div class="smallNote">Kopi kecil ‚Ä¢ Sore hangat</div>
          <div class="catSticker">üêæ</div>
        </div>
      </section>

      <!-- Block 2 -->
      <section class="block reverse hidden" data-index="2">
        <div class="photo">
          <div class="frame" style="--r:6deg">
            <img src="3.jpg" alt="foto-2" data-caption="Kamu bilang sesuatu yang bikin aku jadi malu, tapi aku senyum terus.">
            <div class="captionStrip">Momen kecil</div>
            <div class="film"></div>
          </div>
          <div class="spotlight"></div>
          <div class="hearts"></div>
          <div class="miniQuote">"senja yang enggan pergi"</div>
        </div>
        <div class="textBlock">
          <h3>Sejenak</h3>
          <div class="heartText" data-raw="Ketika jauhnya jarak, tingginya tembok penghalang tak mampu menghalangi jalan pulang menuju rumah. yaa itu kamu sayang, rumah yang ku maksud, rumah yang selalu memberikan kehagatan di dalamnya"></div>
          <div class="smallNote">Jalan pulang ‚Ä¢ Senyummu</div>
          <div class="catSticker">üê±</div>
        </div>
      </section>

      <!-- Monologue -->
      <section class="mono hidden" data-index="mono">
        <h2>Ketika aku ingat kamu</h2>
        <p>Di antara hal hal kecil yang mengisi hari, namamu selalu menemukan celah untuk mendekam manis dalam pikiran. Aku menulis ini bukan untuk dirayakan ‚Äî tetapi sebagai catatan kecil bahwa kamu pernah membuat segalanya terasa cukup. Biarkan halaman ini menjadi tempat aku menyimpan kata-kata yang kadang malu diucapkan langsung.</p>
      </section>

      <!-- Block 3 -->
      <section class="block hidden" data-index="3">
        <div class="photo">
          <div class="frame" style="--r:-2deg">
            <img src="5.jpg" alt="foto-3" data-caption="Selfie sederhana tapi kenangan besar.">
            <div class="captionStrip">Selfie</div>
            <div class="film"></div>
          </div>
          <div class="spotlight"></div>
          <div class="hearts"></div>
          <div class="miniQuote">"rumah dalam senyummu"</div>
        </div>
        <div class="textBlock">
          <h3>Malam kecil</h3>
          <div class="heartText" data-raw="Dalam senyum kecilmu dan dalam setiap kebahagian yang kamu bagikan ke aku, aku temukan rumah yang tak pernah kutahu sebelumnya."></div>
          <div class="smallNote">Selfie ‚Ä¢ Tawa pelan</div>
          <div class="catSticker">üêæ</div>
        </div>
      </section>

      <!-- VIDEO section (puncak) -->
      <section class="mono hidden" data-index="video-intro">
        <h2 style="font-family:'Dancing Script',cursive">sepotong waktu yang di percepat</h2>
        <p class="videoCaption">Videonya aku percepat, karena waktu hari itu terasa cepat juga.</p>
      </section>

      <section class="videoWrap hidden" data-index="video">
        <!-- REPLACE src with your processed video file (mp4) -->
        <video id="memVideo" controls playsinline preload="metadata" crossorigin="anonymous">
          <source src="satu.mp4" type="video/mp4">
          Browser kamu tidak mendukung video ini.
        </video>
        <button id="playVideoBtn" class="playVideoBtn">Play the video ‚Äî fokus audio to video</button>
        <div class="videoCaption">sepotong kenangan kita</div>
      </section>

      <!-- Post-video emotional block -->
      <section class="mono hidden" data-index="post-video">
        <p class="heartText" style="font-family:'Playfair Display',serif; font-size:18px; color:#342f2a; max-width:760px; margin:0 auto;">
          Ada sesuatu di cara kamu menjalani haei, cara kamu ngomong, bahkan cara kamu diem‚Ä¶ yang bikin aku ngerasa‚Äî<strong>kamu itu rumah yang nggak sengaja aku temukan.</strong><br><br>
          Aku suka lihat kita dari sedikit jauh, kayak dua orang yang pelan-pelan jatuh tanpa sadar. Momen sesederhana itu aja cukup buat bikin aku mikir, ‚Äúaku senang banget ketemu kamu.‚Äù
        </p>
        <p style="opacity:0.6; margin-top:16px; text-align:center;"><em>aku kangen momen kayak gini.</em></p>
      </section>

      <!-- Block 4 -->
      <section class="block reverse hidden" data-index="4">
        <div class="photo">
          <div class="frame" style="--r:4deg">
            <img src="4.jpg" alt="foto-4" data-caption="Kita yang lupa arah tapi nggak masalah karena bareng.">
            <div class="captionStrip">Kenangan</div>
            <div class="film"></div>
          </div>
          <div class="spotlight"></div>
          <div class="hearts"></div>
          <div class="miniQuote">"saya simpan ini, untuk nanti"</div>
        </div>
        <div class="textBlock">
          <h3>Terima kasih</h3>
          <div class="heartText" data-raw="Terima kasih karena pernah hadir‚Äîdengan cara paling lembut yang bahkan dunia pun tak ajarkan. Aku menyayangimu dengan sunyi yang dalam, yang tak butuh banyak kata."></div>
          <div class="smallNote">Bab berikutnya menunggu</div>
          <div class="catSticker">üê±</div>
        </div>
      </section>

      <!-- Pause -->
      <section class="mono hidden" data-index="pause">
        <p style="font-size:18px;color:#4b4037;text-align:center;"><em>di sini aku berhenti sebentar‚Ä¶ cuma buat mikirin kamu.</em></p>
      </section>

      <!-- Ending -->
      <section class="mono hidden" data-index="ending">
        <h2 style="font-family:'Dancing Script',cursive">Untukmu.</h2>
        <p style="max-width:720px;margin:16px auto;color:#4b4037;line-height:1.8;">
          Kalau nanti hidup ngebawa kita ke tempat berbeda, aku cuma mau kamu tau satu hal‚Ä¶ Aku pernah sayang sama kamu dengan setulus tulusnya, dan dengan cara yang nggak bising.
        </p>
      </section>

      <div style="height:40px"></div>
      <footer style="text-align:center;color:var(--muted);font-size:13px;margin-bottom:80px"></footer>
    </main>
  </div>

  <!-- final overlay -->
  <div id="finalOverlay" class="finalOverlay" aria-hidden="true">
    <div style="max-width:720px;padding:36px;border-radius:14px;text-align:center">
      <h2 style="font-family:'Dancing Script',cursive;font-size:36px;margin:0;color:var(--paper)">Untukmu.</h2>
      <p style="margin-top:18px;color:#e9dfd1;font-size:18px">Satu halaman kecil untuk kita. Terima kasih sudah menjalani cerita ini bersamaku.</p>
      <div style="margin-top:18px"><button id="closeFinal" style="padding:10px 16px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:700;cursor:pointer">Tutup</button></div>
    </div>
  </div>

<script>
/* ---------------------------
  Helpers: fade audio in/out (promise)
---------------------------- */
const bgm = document.getElementById('bgm');
// default bgm base volume (when fully on). You can lower this if you want more subtle music.
const BGM_TARGET_VOLUME = 0.22; // adjust (0.0 - 1.0)
bgm.volume = 0;
let bgmPlayingBecauseIntro = false;

function fadeAudioTo(audioEl, targetVol = 0, duration = 500){
  return new Promise((resolve)=>{
    try{
      const start = audioEl.volume;
      const diff = targetVol - start;
      const steps = Math.max(6, Math.round((duration/50))); // ~ every 50ms
      let cur = 0;
      const interval = setInterval(()=>{
        cur++;
        const p = cur / steps;
        const v = Math.min(1, Math.max(0, start + diff * p));
        audioEl.volume = v;
        if(cur >= steps){
          clearInterval(interval);
          if(targetVol === 0) {
            try{ audioEl.pause(); }catch(e){}
          }
          resolve();
        }
      }, Math.round(duration/steps));
    }catch(e){
      resolve();
    }
  });
}

/* ---------------------------
  Start bgm when intro clicked (user interaction)
---------------------------- */
document.getElementById('enterBtn').addEventListener('click', async ()=>{
  // hide intro
  document.getElementById('intro').style.display = 'none';
  window.scrollTo({top:0,behavior:'smooth'});

  // start bgm (fade in)
  try{
    await bgm.play(); // start playback (user interaction allows it)
    bgmPlayingBecauseIntro = true;
  }catch(e){
    // ignore autoplay errors
    bgmPlayingBecauseIntro = false;
  }
  // fade to target volume
  await fadeAudioTo(bgm, BGM_TARGET_VOLUME, 700);
  // mark toggle UI active
  updateBgmToggleUI();
});

/* ---------------------------
  BGM toggle (header button)
---------------------------- */
const bgmToggle = document.getElementById('bgmToggle');
function updateBgmToggleUI(){
  if(!bgm) return;
  if(!bgm.paused && bgm.volume > 0.01){
    bgmToggle.classList.add('active');
    bgmToggle.textContent = 'üîä BGM';
  } else {
    bgmToggle.classList.remove('active');
    bgmToggle.textContent = 'üîà BGM';
  }
}
bgmToggle.addEventListener('click', async ()=>{
  if(bgm.paused || bgm.volume < 0.01){
    try{ await bgm.play(); }catch(e){}
    await fadeAudioTo(bgm, BGM_TARGET_VOLUME, 500);
  } else {
    await fadeAudioTo(bgm, 0, 350);
  }
  updateBgmToggleUI();
});

/* ---------------------------
  Create dust particles
---------------------------- */
(function createDust(){
  const dust = document.getElementById('dust');
  for(let i=0;i<40;i++){
    const s = document.createElement('span');
    const size = Math.random()*4+1;
    s.style.width = s.style.height = size + 'px';
    s.style.left = Math.random()*100 + '%';
    s.style.top = Math.random()*100 + '%';
    s.style.opacity = (Math.random()*0.6).toString();
    dust.appendChild(s);
    animateDust(s);
  }
  function animateDust(el){
    const dur = 6000 + Math.random()*8000;
    el.animate([{transform:'translateY(0px)'},{transform:'translateY(-40px)'}],{duration:dur,iterations:Infinity,direction:'alternate',easing:'ease-in-out'});
  }
})();

/* ---------------------------
  IntersectionObserver: reveal sections, typing, hearts
---------------------------- */
const revealElements = document.querySelectorAll('.block, .mono, .videoWrap');
const io = new IntersectionObserver((entries)=>{
  entries.forEach(ent=>{
    if(ent.isIntersecting){
      const el = ent.target;
      if(!el.classList.contains('visible')){
        el.classList.add('visible'); el.classList.remove('hidden');
        // hearts for blocks
        if(el.classList && el.classList.contains('block')) launchHearts(el);
        // typing
        const heartEl = el.querySelector && el.querySelector('.heartText');
        if(heartEl) startTyping(heartEl);
      }
    }
  });
},{threshold:0.24});
revealElements.forEach(el=>io.observe(el));

/* hearts */
function launchHearts(block){
  const wrapper = block.querySelector('.hearts'); if(!wrapper) return;
  for(let i=0;i<6;i++){
    const h = document.createElement('div'); h.className='heart'; h.textContent='üíú';
    h.style.position='absolute'; h.style.left = (10 + Math.random()*80) + '%'; h.style.top = (60 + Math.random()*20) + '%';
    h.style.opacity=0; h.style.fontSize = (14 + Math.random()*8) + 'px';
    wrapper.appendChild(h);
    requestAnimationFrame(()=>{ h.style.transition='transform .9s, opacity .9s'; h.style.opacity=1; h.style.transform='translateY(-80px) scale(1.05)';});
    setTimeout(()=>{ h.style.opacity=0; h.style.transform='translateY(-140px) scale(0.9)'; }, 700 + Math.random()*600);
    setTimeout(()=> { try{ wrapper.removeChild(h) }catch(e){} }, 1400 + Math.random()*600);
  }
}

/* typing effect */
function startTyping(el){
  if(!el || el.dataset.started) return; el.dataset.started='1';
  const raw = el.getAttribute('data-raw') || el.textContent || '';
  el.textContent = '';
  let i=0; const speed = 24;
  const caret = document.createElement('span'); caret.className='caret'; el.appendChild(caret);
  function step(){
    if(i < raw.length){
      const ch = raw.charAt(i);
      if(ch === '\n') el.appendChild(document.createElement('br'));
      else el.insertBefore(document.createTextNode(ch), caret);
      i++; setTimeout(step, speed);
    } else {
      if(caret && caret.parentNode) caret.remove();
    }
  }
  step();
}

/* image modal (click to view) */
const modal = document.createElement('div'); modal.style.position='fixed'; modal.style.inset='0'; modal.style.background='rgba(0,0,0,0.94)'; modal.style.display='none'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex='900';
const modalImg = document.createElement('img'); modalImg.style.maxWidth='92%'; modalImg.style.maxHeight='84vh'; modalImg.style.borderRadius='12px'; modal.appendChild(modalImg);
const modalCap = document.createElement('div'); modalCap.style.color='#f6efe6'; modalCap.style.textAlign='center'; modalCap.style.marginTop='12px'; modal.appendChild(modalCap);
document.body.appendChild(modal);
document.querySelectorAll('.frame img').forEach(img=>{
  img.style.cursor='pointer';
  img.addEventListener('click', ()=>{ modalImg.src = img.src; modalCap.textContent = img.dataset.caption || ''; modal.style.display='flex'; });
  // keyboard accessibility
  img.tabIndex = 0;
  img.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') img.click(); });
});
modal.addEventListener('click', ()=> modal.style.display='none');

/* final overlay when last block fully visible (improved for mobile) */
let finalShown = false;
const lastBlock = document.querySelector('.mono[data-index="ending"]') || document.querySelector('.block[data-index="4"]');

// robust check: require most of the element to be within viewport
function isMostlyInView(el, visibleRatio=0.85){
  if(!el) return false;
  const rect = el.getBoundingClientRect();
  const vh = window.innerHeight || document.documentElement.clientHeight;
  // compute visible height of element
  const visibleTop = Math.max(rect.top, 0);
  const visibleBottom = Math.min(rect.bottom, vh);
  const visibleHeight = Math.max(0, visibleBottom - visibleTop);
  const elHeight = Math.max(1, rect.height);
  const ratio = visibleHeight / elHeight;
  return ratio >= visibleRatio && rect.top >= -20; // also allow slight negative top due to address bar
}

// debounce helper
function debounce(fn, wait){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), wait); }; }

function tryShowFinal(){
  if(finalShown) return;
  if(!lastBlock) return;
  // require that lastBlock is mostly visible (85%) to avoid showing overlay too early on mobile
  if(isMostlyInView(lastBlock, 0.85)){
    finalShown = true;
    setTimeout(()=>{
      document.getElementById('finalOverlay').classList.add('show');
      document.getElementById('finalOverlay').setAttribute('aria-hidden','false');
    }, 900);
  }
}

// Use IntersectionObserver as an accelerator but still validate with bounding box
if(lastBlock){
  const observer = new IntersectionObserver((entries)=>{
    entries.forEach(entry => {
      if(entry.isIntersecting){
        // small debounce before final check (handles mobile UI chrome resize)
        debounce(tryShowFinal, 300)();
      }
    });
  }, {threshold: 0.55});
  observer.observe(lastBlock);

  // also listen to scroll/resize to handle mobile address bar changes reliably
  const onScrollResize = debounce(tryShowFinal, 180);
  window.addEventListener('scroll', onScrollResize, {passive:true});
  window.addEventListener('resize', onScrollResize);
}

// close button handler (keep existing behavior)
document.getElementById('closeFinal').addEventListener('click', ()=>{
  document.getElementById('finalOverlay').classList.remove('show'); 
  document.getElementById('finalOverlay').setAttribute('aria-hidden','true');
});/* Surprise mini-lines + emph on double-click */
const surpriseLines = [
  'Ingat waktu kita nyasar? Aku malah ngerasa itu petualangan kita.',
  'Kamu pernah bilang aku aneh‚Äîaku kira itu pujian terbaik.',
  'Ada satu tempat di kepalaku yang selalu kamu huni, diam-diam.',
  'Kalau aku boleh pilih ulang hari, aku pilih hari itu lagi.',
  'Kamu bawa hangat‚Äîlebih dari yang kupikirkan.'
];
function showSurprise(text){
  const el = document.createElement('div'); el.className='surprise'; el.textContent = text; el.style.opacity = 0;
  document.body.appendChild(el);
  setTimeout(()=> el.style.opacity = 1, 10);
  setTimeout(()=> el.style.opacity = 0, 4200);
  setTimeout(()=> { try{ el.remove() }catch(e){} }, 4800);
}
document.querySelectorAll('.frame img').forEach(img=>{
  img.addEventListener('dblclick', ()=>{
    const line = surpriseLines[Math.floor(Math.random()*surpriseLines.length)];
    showSurprise(line);
    const block = img.closest('.block');
    if(block){ block.classList.add('emph'); setTimeout(()=> block.classList.remove('emph'), 1200); }
  });
});

/* small responsive fix for reversed blocks */
function fixReverse(){ document.querySelectorAll('.block.reverse').forEach(b=>{ if(window.innerWidth<=980) b.style.direction='ltr'; else b.style.direction=''; }); }
window.addEventListener('resize', fixReverse); fixReverse();

/* ---------------------------
  VIDEO <-> BGM interactions (FIXED resume logic)
---------------------------- */
const memVideo = document.getElementById('memVideo');
const playVideoBtn = document.getElementById('playVideoBtn');

// track whether bgm was audible before video play
let bgmWasAudibleBeforeVideo = false;

async function safePlayThenFadeInBgm(targetVolume = BGM_TARGET_VOLUME, duration = 600){
  if(!bgm) return;
  try{
    if(bgm.paused){
      await bgm.play().catch(()=>{});
    }
  }catch(e){}
  await fadeAudioTo(bgm, targetVolume, duration);
  updateBgmToggleUI();
}

async function onVideoPlayTriggeredByUser(){
  bgmWasAudibleBeforeVideo = (!bgm.paused && bgm.volume > 0.01);
  try{ await fadeAudioTo(bgm, 0, 380); }catch(e){}
  try{ await memVideo.play(); }catch(e){}
  updateBgmToggleUI();
}
playVideoBtn.addEventListener('click', onVideoPlayTriggeredByUser);

memVideo.addEventListener('play', async ()=>{
  bgmWasAudibleBeforeVideo = (!bgm.paused && bgm.volume > 0.01);
  if(!bgm.paused && bgm.volume > 0.01){
    await fadeAudioTo(bgm, 0, 380);
    updateBgmToggleUI();
  }
});

memVideo.addEventListener('pause', async ()=>{
  if(bgmWasAudibleBeforeVideo){
    await safePlayThenFadeInBgm(BGM_TARGET_VOLUME, 600);
  }
});

memVideo.addEventListener('ended', async ()=>{
  if(bgmWasAudibleBeforeVideo){
    await safePlayThenFadeInBgm(BGM_TARGET_VOLUME, 600);
  }
});
/* Optional: resume BGM if user seeks out of playing state */
memVideo.addEventListener('emptied', ()=>{ fadeAudioTo(bgm, BGM_TARGET_VOLUME, 600); updateBgmToggleUI(); });

/* update UI on page load */
updateBgmToggleUI();

</script>
</body>
</html>
